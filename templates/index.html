<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”æƒ³è®°å¿†èƒŒå•è¯ç³»ç»Ÿ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¡€æ ·å¼å’Œå­—ä½“è®¾ç½® */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
            /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šæœ‰æ»šåŠ¨ç©ºé—´ */
        }

        .container {
            max-width: 900px;
            width: 95%;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 5px rgba(0, 0, 0, 0.05);
            padding: 30px;
        }

        /* Tab èœå•æ ·å¼ */
        .tab-menu {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
        }

        .tab-button.active {
            color: #1d4ed8;
            border-bottom: 3px solid #1d4ed8;
            background-color: #f8fafc;
        }

        /* éšè—æœªæ¿€æ´»çš„ Tab å†…å®¹ */
        .tab-content {
            display: none;
        }

        /* å•è¯å¡ç‰‡æ ·å¼ */
        #word-card {
            min-height: 250px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #1d4ed8;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-3xl font-extrabold text-blue-700 mb-6">è”æƒ³è®°å¿†èƒŒå•è¯ç³»ç»Ÿ</h1>

        <!-- Tab èœå• -->
        <div class="tab-menu">
            <button class="tab-button active" onclick="openTab(event, 'review-section')">ğŸ”„ æ™ºèƒ½å¤ä¹ </button>
            <button class="tab-button" onclick="openTab(event, 'query-section')">ğŸ” è”æƒ³æŸ¥è¯¢</button>
        </div>

        <!-- 1. æ™ºèƒ½å¤ä¹  Tab å†…å®¹ -->
        <div id="review-section" class="tab-content">
            <!-- å¤ä¹ è¿›åº¦æ¡ ** [ä¼˜åŒ–] ** -->
            <div id="review-progress-container" class="mb-4">
                <div class="text-sm font-medium text-gray-600 mb-1 flex justify-between">
                    <span>å¤ä¹ è¿›åº¦</span>
                    <span id="progress-text">0/0 (0%)</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar"
                        class="bg-blue-600 h-2.5 rounded-full transition-all duration-500 ease-in-out"
                        style="width: 0%">
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <button id="start-review-button"
                    class="w-full py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    å¼€å§‹å¤ä¹  / åˆ·æ–°å¾…å¤ä¹ åˆ—è¡¨
                </button>
            </div>

            <!-- å•è¯å¡ç‰‡åŒº -->
            <!-- æ ¸å¿ƒæ”¹åŠ¨åŒºåŸŸï¼šå¢åŠ äº† card-phonetic å’Œ card-meaning-group å®¹å™¨ -->
            <div id="word-card" class="mb-6 flex flex-col justify-between">
                <!-- åŠ è½½æŒ‡ç¤ºå™¨ ** [ä¼˜åŒ–] ** -->
                <div id="loading-spinner" class="spinner hidden"></div>
                <p id="review-status" class="text-gray-500 italic text-sm mb-4">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½å¾…å¤ä¹ å•è¯...</p>
                <div id="current-word-display" class="hidden">
                    <!-- 1. å•è¯ -->
                    <h2 id="card-word" class="text-5xl font-black text-gray-800 mb-2"></h2>

                    <!-- 2. éŸ³æ ‡ (æ–°å¢åŠ ) -->
                    <!-- ä½¿ç”¨ font-serif æˆ–å…¶ä»–å­—ä½“æ¥æ¨¡æ‹ŸéŸ³æ ‡çš„ä¸“ä¸šæ„Ÿ -->
                    <p id="card-phonetic" class="text-2xl text-gray-500 font-serif mb-4"></p>

                    <!-- 3. è¯æ€§ + é‡Šä¹‰ ç»„åˆæ¡† (æ–°å¢åŠ ï¼Œç”¨äºç»Ÿä¸€æ§åˆ¶æ˜¾ç¤º/éšè—) -->
                    <div id="card-meaning-group" class="mb-6 hidden w-full">
                        <!-- ç¡®ä¿å†…å®¹å±…ä¸­ -->
                        <p class="text-2xl text-gray-700 font-serif flex justify-center items-start">
                            <!-- è¯æ€§ (æ–°å¢åŠ ï¼Œä½äºé‡Šä¹‰å‰é¢) -->
                            <span id="card-pos" class="mr-3 text-blue-600 font-bold italic text-xl"></span>
                            <!-- é‡Šä¹‰æ–‡æœ¬ -->
                            <span id="card-meaning-text"></span>
                        </p>
                    </div>

                    <p id="card-status" class="text-sm text-gray-400 mt-2"></p>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’®åŒº -->
            <div id="action-buttons" class="hidden">
                <div class="flex justify-center space-x-4 mb-6">
                    <button id="show-meaning-button"
                        class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">æ˜¾ç¤º/éšè—é‡Šä¹‰
                        (Space)</button>
                    <!-- è”æƒ³æç¤ºå¼€å…³ -->
                    <button id="hint-toggle"
                        class="px-6 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed">åŠ è½½è”æƒ³æç¤º</button>
                </div>

                <!-- è”æƒ³æç¤ºå†…å®¹ -->
                <div id="hint-content-card" class="bg-indigo-50 p-4 rounded-lg mb-6 hidden">
                    <h3 class="font-semibold text-indigo-800 mb-2 border-b border-indigo-200 pb-1">è”æƒ³æç¤º</h3>
                    <div id="hint-content" class="text-sm text-indigo-700 max-h-40 overflow-y-auto">
                        <!-- è”æƒ³è¯æ±‡å°†åŠ è½½åˆ°è¿™é‡Œ -->
                    </div>
                </div>

                <!-- è®°å¿†è¯„åˆ†æŒ‰é’® -->
                <div class="text-center mb-4">
                    <p class="text-lg font-semibold text-gray-700 mb-3">æˆ‘è®°ä½äº†å¤šå°‘ï¼Ÿ (é”®ç›˜ 0-5)</p>
                    <div class="flex justify-between space-x-1">
                        <!-- è¯„åˆ†æŒ‰é’® 0-5 -->
                        <button data-quality="0" title="å®Œå…¨å¿˜è®°"
                            class="quality-btn flex-1 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 shadow-md disabled:bg-gray-400">0</button>
                        <button data-quality="1" title="åˆå¿˜äº†"
                            class="quality-btn flex-1 py-3 bg-red-400 text-white font-bold rounded-lg hover:bg-red-500 transition duration-150 shadow-md disabled:bg-gray-400">1</button>
                        <button data-quality="2" title="å‹‰å¼ºè®°å¾—"
                            class="quality-btn flex-1 py-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md disabled:bg-gray-400">2</button>
                        <button data-quality="3" title="è®°ä½äº†ï¼ŒçŠ¹è±«"
                            class="quality-btn flex-1 py-3 bg-green-400 text-white font-bold rounded-lg hover:bg-green-500 transition duration-150 shadow-md disabled:bg-gray-400">3</button>
                        <button data-quality="4" title="è®°ä½äº†ï¼Œæµåˆ©"
                            class="quality-btn flex-1 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 shadow-md disabled:bg-gray-400">4</button>
                        <button data-quality="5" title="å®Œç¾è®°ä½"
                            class="quality-btn flex-1 py-3 bg-green-700 text-white font-bold rounded-lg hover:bg-green-800 transition duration-150 shadow-md disabled:bg-gray-400">5</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- 2. è”æƒ³æŸ¥è¯¢ Tab å†…å®¹ -->
        <div id="query-section" class="tab-content">
            <div class="flex mb-4 space-x-3">
                <input type="text" id="query-word" placeholder="è¾“å…¥è¦æŸ¥è¯¢çš„å•è¯"
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="search-button"
                    class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    æŸ¥è¯¢è”æƒ³è¯
                </button>
            </div>

            <!-- è”æƒ³æ¨¡å¼é€‰æ‹© -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label for="query-mode" class="block text-sm font-medium text-gray-700 mb-2">è”æƒ³æ¨¡å¼ï¼š</label>
                <div class="flex space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="query-mode" value="total" checked
                            class="form-radio text-indigo-600 h-4 w-4">
                        <span class="ml-2 text-gray-700">æ€»åˆ†æ¨¡å¼ (è¯­ä¹‰+å­—å½¢)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="query-mode" value="semantic"
                            class="form-radio text-indigo-600 h-4 w-4">
                        <span class="ml-2 text-gray-700">è¯­ä¹‰æ¨¡å¼ (ä»…è¯­ä¹‰)</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="query-mode" value="form" class="form-radio text-indigo-600 h-4 w-4">
                        <span class="ml-2 text-gray-700">å­—å½¢æ¨¡å¼ (ä»…å­—å½¢)</span>
                    </label>
                </div>
                <div class="mt-3 text-sm text-gray-500">
                    åœ¨â€œè¯­ä¹‰/å­—å½¢æ¨¡å¼â€ä¸‹ï¼Œå°†æ˜¾ç¤ºæ‰€æœ‰ç›¸ä¼¼åº¦å¤§äº 0.7 çš„è¯ã€‚
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒº -->
            <div class="bg-white p-5 rounded-lg border border-gray-300 shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-3 flex justify-between items-center">
                    è”æƒ³ç»“æœ
                    <span class="text-sm font-normal text-gray-500">
                        æ‰¾åˆ° <span id="recommendation-count" class="font-bold text-indigo-600">0</span> ä¸ªè¯æ±‡
                    </span>
                </h3>
                <div id="recommendation-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 italic">åœ¨æ­¤è¾“å…¥å•è¯è¿›è¡ŒæŸ¥è¯¢...</p>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤ºæ¡† -->
        <div id="message-box"
            class="fixed bottom-4 right-4 p-4 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 hidden"
            role="alert">
        </div>

        <!-- æ¨¡æ€æ¡† ** [ä¼˜åŒ–] ** -->
        <div id="modal-backdrop"
            class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
            <div id="modal-box"
                class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:w-1/3 transform transition-all duration-300 scale-95 opacity-0">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">æç¤º</h3>
                <p id="modal-content" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end">
                    <button id="modal-close-button"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // *** ä¿®å¤é”™è¯¯çš„å…³é”®ï¼šæ˜ç¡®æŒ‡å®š API æœåŠ¡å™¨çš„ URL ***
        const API_BASE_URL = "http://127.0.0.1:5000/api/";

        // ** [ä¼˜åŒ–] ** ç»Ÿä¸€çŠ¶æ€ç®¡ç†å¯¹è±¡
        const appState = {
            reviewWords: [],
            currentWordIndex: 0,
            isLoading: false,
        };

        const elements = {
            reviewStatus: document.getElementById('review-status'),
            loadingSpinner: document.getElementById('loading-spinner'),
            cardDisplay: document.getElementById('current-word-display'),
            actionButtons: document.getElementById('action-buttons'),

            // å•è¯å¡ç‰‡æ ¸å¿ƒå…ƒç´ æ›´æ–°
            cardWord: document.getElementById('card-word'),
            cardPhonetic: document.getElementById('card-phonetic'), // æ–°å¢ï¼šéŸ³æ ‡
            cardPos: document.getElementById('card-pos'),         // æ–°å¢ï¼šè¯æ€§
            cardMeaningText: document.getElementById('card-meaning-text'), // é‡Šä¹‰æ–‡æœ¬
            cardMeaningGroup: document.getElementById('card-meaning-group'), // é‡Šä¹‰å’Œè¯æ€§çš„ç»„åˆå®¹å™¨ï¼Œç”¨äºåˆ‡æ¢æ˜¾ç¤º/éšè—

            cardStatus: document.getElementById('card-status'),
            reviewProgressContainer: document.getElementById('review-progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            startReviewButton: document.getElementById('start-review-button'),
            hintContentCard: document.getElementById('hint-content-card'),
            hintContent: document.getElementById('hint-content'),
            hintToggle: document.getElementById('hint-toggle'),
            searchButton: document.getElementById('search-button'),
        };

        /** æ¶ˆæ¯æç¤ºå‡½æ•° (æ²¿ç”¨ï¼Œä½† Modal ç”¨äºé‡è¦æç¤º) */
        function showMessage(msg, type = 'info') {
            const box = document.getElementById('message-box');
            box.innerText = msg;
            box.className = 'fixed bottom-4 right-4 p-4 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300';

            // è®¾ç½®é¢œè‰²
            if (type === 'success') {
                box.classList.add('bg-green-600');
            } else if (type === 'error') {
                box.classList.add('bg-red-600');
            } else {
                box.classList.add('bg-blue-500');
            }

            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        // ** [ä¼˜åŒ–] ** æ¨¡æ€æ¡†æ˜¾ç¤ºå‡½æ•°
        function showModal(title, content) {
            const backdrop = document.getElementById('modal-backdrop');
            const box = document.getElementById('modal-box');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerText = content;

            backdrop.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('scale-100', 'opacity-100');
                box.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        // ** [ä¼˜åŒ–] ** æ¨¡æ€æ¡†å…³é—­å‡½æ•°
        document.getElementById('modal-close-button').addEventListener('click', () => {
            const backdrop = document.getElementById('modal-backdrop');
            const box = document.getElementById('modal-box');

            box.classList.add('scale-95', 'opacity-0');
            box.classList.remove('scale-100', 'opacity-100');

            setTimeout(() => {
                backdrop.classList.add('hidden');
            }, 300); // ç­‰å¾…è¿‡æ¸¡å®Œæˆ
        });


        /** ç»Ÿä¸€çš„ API Fetch å‡½æ•° (åŠ å…¥ Loading çŠ¶æ€ç®¡ç†) */
        async function apiFetch(endpoint, options = {}, toggleLoading = false) {
            if (appState.isLoading) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (toggleLoading) {
                setLoadingState(true);
            }

            try {
                // ä½¿ç”¨å®Œæ•´çš„ URL
                const response = await fetch(API_BASE_URL + endpoint, options);
                const data = await response.json();

                if (!response.ok) {
                    showModal('API é”™è¯¯', data.error || 'æœåŠ¡å™¨è¿”å›é”™è¯¯ï¼Œè¯·æ£€æŸ¥ Flask åç«¯ã€‚');
                    throw new Error(data.error || 'API call failed');
                }
                return data;
            } catch (error) {
                showModal('ç½‘ç»œæˆ–æœåŠ¡å™¨è¿æ¥å¤±è´¥', `è¯·ç¡®è®¤ Flask æœåŠ¡å™¨ (127.0.0.1:5000) æ­£åœ¨è¿è¡Œã€‚é”™è¯¯ä¿¡æ¯: ${error.message}`);
                throw error;
            } finally {
                if (toggleLoading) {
                    setLoadingState(false);
                }
            }
        }

        // ** [ä¼˜åŒ–] ** åŠ è½½çŠ¶æ€ç®¡ç†å‡½æ•°
        function setLoadingState(isLoading) {
            appState.isLoading = isLoading;
            const buttons = document.querySelectorAll('button:not(#modal-close-button)');
            buttons.forEach(btn => btn.disabled = isLoading);

            if (isLoading) {
                elements.loadingSpinner.classList.remove('hidden');
                elements.cardDisplay.classList.add('hidden');
            } else {
                elements.loadingSpinner.classList.add('hidden');
            }
        }

        /** Tab åˆ‡æ¢é€»è¾‘ */
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.classList.add("active");
        }

        // ** [ä¼˜åŒ–] ** æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const total = appState.reviewWords.length;
            const reviewed = appState.currentWordIndex;
            const percent = total > 0 ? Math.round((reviewed / total) * 100) : 0;

            elements.progressText.innerText = `${reviewed}/${total} (${percent}%)`;
            elements.progressBar.style.width = `${percent}%`;

            if (total === 0) {
                elements.reviewProgressContainer.classList.add('hidden');
            } else {
                elements.reviewProgressContainer.classList.remove('hidden');
            }
        }

        // --- æ™ºèƒ½å¤ä¹ é€»è¾‘ ---

        /** æ˜¾ç¤ºå½“å‰å•è¯å¡ç‰‡ */
        function showCurrentWord() {
            const currentWord = appState.reviewWords[appState.currentWordIndex];

            // éšè—é‡Šä¹‰å’Œæç¤ºï¼Œæ³¨æ„ç°åœ¨ç›®æ ‡æ˜¯ cardMeaningGroup
            elements.cardMeaningGroup.classList.add('hidden');
            elements.hintContentCard.classList.add('hidden');
            elements.hintContent.innerHTML = 'ç‚¹å‡»â€œåŠ è½½è”æƒ³æç¤ºâ€æŒ‰é’®è·å–ã€‚';
            elements.hintToggle.innerText = 'åŠ è½½è”æƒ³æç¤º';

            if (currentWord) {
                elements.cardWord.innerText = currentWord.word;

                // å‡è®¾åç«¯æ•°æ®åŒ…å« phonetic å’Œ pos
                // ä»…ç”¨äºæ¼”ç¤ºï¼Œå®é™…åº”ä»åç«¯APIè·å–
                elements.cardPhonetic.innerText = currentWord.phonetic || '/ÉªÉ¡ËˆzÃ¦mpÉ™l/';
                elements.cardPos.innerText = currentWord.pos || 'n.';
                elements.cardMeaningText.innerText = currentWord.meaning_zh;

                elements.cardStatus.innerText = `å¾…å¤ä¹ ï¼š${appState.reviewWords.length - appState.currentWordIndex} / ${appState.reviewWords.length}`;

                elements.reviewStatus.classList.add('hidden');
                elements.cardDisplay.classList.remove('hidden');
                elements.actionButtons.classList.remove('hidden');

                elements.cardWord.focus(); // èšç„¦å¡ç‰‡
            } else {
                // å¤ä¹ å®Œæˆ
                elements.cardWord.innerText = 'âœ… å¤ä¹ å®Œæˆï¼';
                elements.cardPhonetic.innerText = ''; // æ¸…ç©ºéŸ³æ ‡
                elements.cardPos.innerText = '';      // æ¸…ç©ºè¯æ€§
                elements.cardMeaningText.innerText = 'æ‰€æœ‰å¾…å¤ä¹ è¯æ±‡å·²å¤„ç†ã€‚';
                elements.cardMeaningGroup.classList.remove('hidden'); // æ˜¾ç¤ºå®Œæˆä¿¡æ¯
                elements.cardStatus.innerText = 'ç‚¹å‡»â€œå¼€å§‹å¤ä¹ â€æŒ‰é’®åˆ·æ–°ã€‚';

                elements.reviewStatus.classList.add('hidden');
                elements.cardDisplay.classList.remove('hidden');
                elements.actionButtons.classList.add('hidden');
            }

            updateProgress();
        }

        /** åŠ è½½å¾…å¤ä¹ å•è¯åˆ—è¡¨ */
        async function loadReviewWords() {
            appState.currentWordIndex = 0;
            elements.reviewStatus.innerText = 'æ­£åœ¨åŠ è½½å¾…å¤ä¹ å•è¯...';
            elements.reviewStatus.classList.remove('hidden');
            elements.cardDisplay.classList.add('hidden');
            elements.actionButtons.classList.add('hidden');

            try {
                // ** [ä¼˜åŒ–] ** ä½¿ç”¨ toggleLoading è‡ªåŠ¨ç®¡ç†çŠ¶æ€
                const data = await apiFetch('review_list?limit=50', { method: 'GET' }, true);
                appState.reviewWords = data.words;

                if (appState.reviewWords.length === 0) {
                    showMessage('æ­å–œï¼ç›®å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ã€‚', 'info');
                    elements.reviewStatus.innerText = 'æ­å–œï¼ç›®å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ã€‚';
                } else {
                    showMessage(`æˆåŠŸåŠ è½½ ${appState.reviewWords.length} ä¸ªå¾…å¤ä¹ å•è¯ã€‚`, 'success');
                }

                showCurrentWord(); // æ˜¾ç¤ºç¬¬ä¸€ä¸ªæˆ–å®ŒæˆçŠ¶æ€

            } catch (error) {
                // é”™è¯¯å·²åœ¨ apiFetch ä¸­æ˜¾ç¤º
                elements.reviewStatus.innerText = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿ Flask æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚';
            }
        }

        /** åŠ è½½è”æƒ³æ¨è (åœ¨å¤ä¹ å¡ç‰‡ä¸­ä½¿ç”¨) */
        async function loadHintRecommendations() {
            if (appState.currentWordIndex >= appState.reviewWords.length) return;
            const currentWord = appState.reviewWords[appState.currentWordIndex].word;

            elements.hintContent.innerHTML = '<p class="text-indigo-600 italic">æ­£åœ¨åŠ è½½è”æƒ³è¯...</p>';
            elements.hintToggle.disabled = true; // ç¦ç”¨æŒ‰é’®

            try {
                const data = await apiFetch(`recommend?word=${currentWord}&mode=total&top_n=10`, { method: 'GET' });
                const recommendations = data.recommendations;

                let hintHtml = '';
                if (recommendations.length === 0) {
                    hintHtml = '<p class="text-sm text-gray-500">æœªæ‰¾åˆ°ç›¸å…³è”æƒ³è¯ã€‚</p>';
                } else {
                    hintHtml = '<ul class="space-y-1">';
                    recommendations.forEach(rec => {
                        hintHtml += `<li class="p-1 border-b border-gray-100 last:border-b-0 flex justify-between items-center">
                            <span class="font-semibold text-gray-900">${rec.word}</span>
                            <span class="text-sm text-gray-600">${rec.meaning_zh}</span>
                            <div class="flex space-x-2 text-xs font-mono">
                                <span class="px-1 bg-teal-100 text-teal-700 rounded">Sæ€»: ${rec.S_total.toFixed(4)}</span>
                                <span class="px-1 bg-blue-100 text-blue-700 rounded">Så½¢: ${rec.S_form.toFixed(3)}</span>
                            </div>
                        </li>`;
                    });
                    hintHtml += '</ul>';
                }
                elements.hintContent.innerHTML = hintHtml;

            } catch (error) {
                elements.hintContent.innerHTML = '<p class="text-red-500">è”æƒ³æç¤ºåŠ è½½å¤±è´¥ã€‚</p>';
            } finally {
                elements.hintToggle.disabled = false;
            }
        }

        /** å¤„ç†è®°å¿†è¯„åˆ† */
        async function handleQualityRating(quality) {
            if (appState.currentWordIndex >= appState.reviewWords.length || appState.isLoading) {
                showMessage('å¤ä¹ å·²å®Œæˆæˆ–æ­£åœ¨å¤„ç†ä¸­ã€‚', 'info');
                return;
            }

            const word = appState.reviewWords[appState.currentWordIndex].word;

            try {
                // 1. å‘é€æ›´æ–°è¯·æ±‚
                const result = await apiFetch('update_memory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ word, quality })
                }, true); // ** [ä¼˜åŒ–] ** è¯„åˆ†æ—¶ä¹Ÿæ˜¾ç¤ºåŠ è½½

                showMessage(`å•è¯ '${word}' çŠ¶æ€æ›´æ–°æˆåŠŸã€‚ä¸‹æ¬¡å¤ä¹ ï¼š${result.details.next_review_date.split(' ')[0]}`, 'success');

                // 2. ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå•è¯
                appState.currentWordIndex++;
                showCurrentWord();

            } catch (error) {
                // é”™è¯¯å·²åœ¨ apiFetch ä¸­æ˜¾ç¤º
            }
        }

        // --- è”æƒ³æŸ¥è¯¢ Tab é€»è¾‘ ---

        /** è”æƒ³æŸ¥è¯¢ Tab çš„æŸ¥è¯¢åŠŸèƒ½ */
        async function fetchAssociationRecommendations() {
            const queryWord = document.getElementById('query-word').value.trim();
            const mode = document.querySelector('input[name="query-mode"]:checked').value;
            const listElement = document.getElementById('recommendation-list');
            const countElement = document.getElementById('recommendation-count');

            if (!queryWord) {
                showMessage('è¯·è¾“å…¥æŸ¥è¯¢çš„å•è¯ã€‚', 'info');
                return;
            }

            listElement.innerHTML = '<p class="text-indigo-600">æ­£åœ¨æŸ¥è¯¢è”æƒ³è¯...</p>';
            countElement.innerText = '...';
            elements.searchButton.disabled = true; // ç¦ç”¨æŒ‰é’®

            try {
                const data = await apiFetch(`recommend?word=${queryWord}&mode=${mode}&threshold=0.7&top_n=10`, { method: 'GET' });
                const recommendations = data.recommendations;

                let listHtml = '';
                recommendations.forEach(rec => {
                    listHtml += `
                        <li class="p-3 border border-gray-100 flex justify-between items-center bg-white hover:bg-gray-50 rounded-md transition-colors">
                            <div class="flex flex-col">
                                <span class="font-semibold text-lg text-gray-800">${rec.word}</span>
                                <span class="text-sm text-gray-500">${rec.meaning_zh}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-mono px-2 py-1 bg-teal-100 text-teal-700 rounded-full">
                                    Sæ€»: ${rec.S_total.toFixed(4)}
                                </span>
                                <span class="text-xs font-mono px-2 py-1 bg-blue-100 text-blue-700 rounded-full ml-2">
                                    Så½¢: ${rec.S_form.toFixed(3)}
                                </span>
                            </div>
                        </li>
                    `;
                });
                listElement.innerHTML = `<ul class="space-y-2">${listHtml}</ul>`;
                countElement.innerText = recommendations.length;

            } catch (error) {
                listElement.innerHTML = `<li class="text-red-500">è”æƒ³æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ã€‚</li>`;
                countElement.innerText = '0';
            } finally {
                elements.searchButton.disabled = false;
            }
        }


        // --- ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ ---

        /** è®°å¿†è¯„åˆ†æŒ‰é’® */
        document.querySelectorAll('.quality-btn').forEach(button => {
            button.addEventListener('click', function () {
                const quality = parseInt(this.getAttribute('data-quality'));
                handleQualityRating(quality);
            });
        });

        /** å¯åŠ¨å¤ä¹ æµç¨‹ */
        elements.startReviewButton.addEventListener('click', loadReviewWords);

        /** è”æƒ³æŸ¥è¯¢ Tab çš„æŸ¥è¯¢æŒ‰é’® */
        elements.searchButton.addEventListener('click', fetchAssociationRecommendations);

        /** æ˜¾ç¤º/éšè—é‡Šä¹‰ */
        document.getElementById('show-meaning-button').addEventListener('click', function () {
            // ç°åœ¨åˆ‡æ¢çš„æ˜¯åŒ…å«è¯æ€§å’Œé‡Šä¹‰çš„æ•´ä¸ªå®¹å™¨
            elements.cardMeaningGroup.classList.toggle('hidden');
        });

        /** æç¤ºå¼€å…³é€»è¾‘ (å¤ä¹ æ¨¡å¼) */
        elements.hintToggle.addEventListener('click', async function () {
            if (elements.hintContentCard.classList.contains('hidden')) {
                // å¦‚æœå½“å‰æ˜¯éšè—çŠ¶æ€ï¼Œåˆ™åŠ è½½å†…å®¹å¹¶æ˜¾ç¤º
                await loadHintRecommendations();
                elements.hintContentCard.classList.remove('hidden');
                this.innerText = 'éšè—è”æƒ³æç¤º';
            } else {
                // å¦‚æœå½“å‰æ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œåˆ™éšè—
                elements.hintContentCard.classList.add('hidden');
                this.innerText = 'åŠ è½½è”æƒ³æç¤º';
            }
        });

        // ** [ä¼˜åŒ–] ** é”®ç›˜äº‹ä»¶ç›‘å¬ (ç»‘å®šåˆ° body æé«˜æ•ˆç‡)
        document.addEventListener('keydown', (e) => {
            // ç¡®ä¿åœ¨å¤ä¹  Tab ä¸”ä¸åœ¨è¾“å…¥æ¡†ä¸­æ—¶è§¦å‘
            const isReviewTab = document.getElementById('review-section').style.display !== 'none';
            const isInputFocused = document.activeElement.tagName === 'INPUT';

            if (!isReviewTab || isInputFocused || appState.isLoading) return;

            // 1. 0-5 è¯„åˆ†å¿«æ·é”®
            if (e.key >= '0' && e.key <= '5') {
                e.preventDefault();
                const quality = parseInt(e.key);
                document.querySelector(`.quality-btn[data-quality="${quality}"]`).focus(); // æä¾›è§†è§‰åé¦ˆ
                handleQualityRating(quality);
            }
            // 2. Spacebar æ˜¾ç¤º/éšè—é‡Šä¹‰
            else if (e.key === ' ') {
                e.preventDefault();
                elements.cardMeaningGroup.classList.toggle('hidden'); // åˆ‡æ¢é‡Šä¹‰å®¹å™¨
            }
            // 3. Enter åˆ‡æ¢è”æƒ³æç¤º
            else if (e.key === 'Enter') {
                e.preventDefault();
                elements.hintToggle.click();
            }
        });

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', async () => {
            // é»˜è®¤æ‰“å¼€å¤ä¹  Tab
            const firstTabButton = document.querySelector('.tab-menu .tab-button:nth-child(1)');
            if (firstTabButton) {
                const mockEvent = { currentTarget: firstTabButton };
                openTab(mockEvent, 'review-section');
            }
            // é¦–æ¬¡åŠ è½½æ—¶ä¸è‡ªåŠ¨è·å–å¤ä¹ åˆ—è¡¨ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»
            updateProgress();
        });
    </script>
</body>

</html>